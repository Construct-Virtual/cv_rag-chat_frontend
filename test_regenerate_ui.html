<!DOCTYPE html>
<html>
<head>
    <title>Test Regenerate Feature</title>
</head>
<body style="font-family: Arial; padding: 20px; background: #111; color: #fff;">
    <h1>Regenerate Feature Test</h1>
    <div id="status"></div>
    <div id="messages"></div>
    <button onclick="loadMessages()">Load Messages</button>
    <button onclick="regenerateLast()">Regenerate Last Assistant Message</button>

    <script>
        const API_URL = 'http://localhost:8002';
        let token = '';
        let conversationId = 'cfa18840-995d-4bd5-b66e-a172d516f788';
        let messages = [];

        async function login() {
            const resp = await fetch(`${API_URL}/api/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: 'admin', password: 'password123' })
            });
            const data = await resp.json();
            token = data.access_token;
            document.getElementById('status').innerHTML = 'Logged in!';
        }

        async function loadMessages() {
            const resp = await fetch(`${API_URL}/api/chat/conversations/${conversationId}/messages`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            messages = await resp.json();
            displayMessages();
        }

        function displayMessages() {
            const container = document.getElementById('messages');
            container.innerHTML = messages.map(m =>
                `<div style="margin: 10px 0; padding: 10px; background: ${m.role === 'user' ? '#3B82F6' : '#1A1A1A'}; border-radius: 8px;">${m.role}: ${m.content.substring(0, 100)}...</div>`
            ).join('');
        }

        async function regenerateLast() {
            const lastAssistant = messages.filter(m => m.role === 'assistant').pop();
            if (!lastAssistant) {
                alert('No assistant message to regenerate');
                return;
            }

            document.getElementById('status').innerHTML = 'Regenerating...';
            messages = messages.filter(m => m.id !== lastAssistant.id);
            displayMessages();

            const response = await fetch(`${API_URL}/api/chat/messages/${lastAssistant.id}/regenerate`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let streamingDiv = document.createElement('div');
            streamingDiv.style = 'margin: 10px 0; padding: 10px; background: #1A1A1A; border-radius: 8px; opacity: 0.7;';
            document.getElementById('messages').appendChild(streamingDiv);

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = JSON.parse(line.substring(6));

                        if (data.type === 'token') {
                            streamingDiv.innerHTML = 'AI: ' + data.full_content;
                        } else if (data.type === 'complete') {
                            document.getElementById('status').innerHTML = 'Complete! Reloading...';
                            await loadMessages();
                        } else if (data.type === 'error') {
                            document.getElementById('status').innerHTML = 'Error: ' + data.message;
                        }
                    }
                }
            }
        }

        login().then(loadMessages);
    </script>
</body>
</html>
